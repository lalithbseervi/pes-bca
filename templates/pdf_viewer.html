{% extends "base.html" %}

{% block main_content %}
<div id="pdf-container">
    <div class="loading-message">
        <h2>Loading document...</h2>
        <p>Verifying access permissions...</p>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Get URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    const pdfPath = urlParams.get('file');
    const sessionToken = urlParams.get('token');
    const sessionExpiry = urlParams.get('expires');
    const title = urlParams.get('title');

    document.title = title;
    
    if (!pdfPath) {
        document.getElementById('pdf-container').innerHTML = '<h2>Error: No file specified</h2>';
        return;
    }

    // Check if session data was passed via URL
    let isValidSession = false;
    
    if (sessionToken && sessionExpiry) {
        // Validate session from URL parameters
        const now = new Date().getTime();
        const expiryTime = parseInt(sessionExpiry);
        isValidSession = now < expiryTime;
    } else {
        // Fallback: check sessionStorage (for same-tab navigation)
        const sessionData = sessionStorage.getItem('user_session');
        if (sessionData) {
            try {
                const session = JSON.parse(sessionData);
                const now = new Date();
                const expiresAt = new Date(session.expiresAt);
                isValidSession = now < expiresAt;
            } catch (error) {
                isValidSession = false;
            }
        }
    }

    // If no valid session, redirect to home
    if (!isValidSession) {
        window.location.href = '/';
        return;
    }

    // If session is valid, show the PDF
    document.getElementById('pdf-container').innerHTML = `
        <div style="width: 100%; height: 90vh;">
            <iframe src="${pdfPath}" 
                    style="width: 100%; height: 100%; border: none;" 
                    type="application/pdf">
                <p>Your browser doesn't support PDF viewing. 
                   <a href="${pdfPath}" download>Download the PDF</a> instead.</p>
            </iframe>
        </div>
    `;
});
</script>
{% endblock main_content %}