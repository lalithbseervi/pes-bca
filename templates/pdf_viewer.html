{% extends "base.html" %}

{% block main_content %}
<style>
.loading-message {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 70vh;
    text-align: center;
}
.loading-message h2 { margin-bottom: 10px; color: #4a90e2; }
.loading-message p { color: #888; }
</style>

<!-- Include login component for session management -->
{% include "components/login.html" %}

<!-- PostHog Analytics -->
<script>
    !function(t,e){var o,n,p,r;e.__SV||(window.posthog=e,e._i=[],e.init=function(i,s,a){function g(t,e){var o=e.split(".");2==o.length&&(t=t[o[0]],e=o[1]),t[e]=function(){t.push([e].concat(Array.prototype.slice.call(arguments,0)))}}(p=t.createElement("script")).type="text/javascript",p.crossOrigin="anonymous",p.async=!0,p.src=s.api_host.replace(".i.posthog.com","-assets.i.posthog.com")+"/static/array.js",(r=t.getElementsByTagName("script")[0]).parentNode.insertBefore(p,r);var u=e;for(void 0!==a?u=e[a]=[]:a="posthog",u.people=u.people||[],u.toString=function(t){var e="posthog";return"posthog"!==a&&(e+="."+a),t||(e+=" (stub)"),e},u.people.toString=function(){return u.toString(1)+".people (stub)"},o="init Ce js Ls Te Fs Ds capture Ye calculateEventProperties Us register register_once register_for_session unregister unregister_for_session Ws getFeatureFlag getFeatureFlagPayload isFeatureEnabled reloadFeatureFlags updateEarlyAccessFeatureEnrollment getEarlyAccessFeatures on onFeatureFlags onSurveysLoaded onSessionId getSurveys getActiveMatchingSurveys renderSurvey displaySurvey canRenderSurveyAsync identify setPersonProperties group resetGroups setPersonPropertiesForFlags resetPersonPropertiesForFlags setGroupPropertiesForFlags resetGroupPropertiesForFlags reset get_distinct_id getGroups get_session_id get_session_replay_url alias set_config startSessionRecording stopSessionRecording sessionRecordingStarted captureException loadToolbar get_property getSessionProperty Bs zs createPersonProfile Hs Ms Gs opt_in_capturing opt_out_capturing has_opted_in_capturing get_explicit_consent_status is_capturing clear_opt_in_out_capturing Ns debug L qs getPageViewId captureTraceFeedback captureTraceMetric".split(" "),n=0;n<o.length;n++)g(u,o[n]);e._i.push([i,s,a])},e.__SV=1)}(document,window.posthog||[]);
    posthog.init('phc_78cRhH8qoYmTyUHbMXdUxqrFPFfrdVp3yxzK0gdqB6Q', {
        api_host: 'https://us.i.posthog.com',
        defaults: '2025-05-24',
        person_profiles: 'identified_only',
    })
</script>

<div id="pdf-container">
    <div class="loading-message">
        <h2>Loading document...</h2>
        <p>Verifying access permissions...</p>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    localStorage.setItem('postLoginRedirect', window.location.href);
    // Get URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    const pdfPath = urlParams.get('file');
    const title = urlParams.get('title');

    if (title) {
        document.title = title;
    }
    
    if (!pdfPath) {
        document.getElementById('pdf-container').innerHTML = '<h2>Error: No file specified</h2>';
        if (window.posthog) {
            posthog.capture('pdf_viewer_error', {
                error: 'No file specified',
                url: window.location.href
            });
        }
        return;
    }

    // Session validation is handled by login.js and login.html
    // If session is valid, login.js will show content and hide login modal
    // If not, login modal will be shown and access denied handled there

    // Load PDF viewer if session is valid (login.js will handle showing/hiding)
    function loadPdfViewer() {
        const pdfViewerUrl = `/pdfjs/web/viewer.html?file=${encodeURIComponent(pdfPath)}`;
        document.getElementById('pdf-container').innerHTML = `
            <div style="width: 100%; height: 90vh;">
                <iframe src="${pdfViewerUrl}" 
                        style="width: 100%; height: 100%; border: none;"
                        allow="fullscreen">
                    <p>Loading PDF viewer...</p>
                </iframe>
            </div>
        `;

        // Track PDF view with PostHog
        const sessionData = sessionStorage.getItem('user_session');
        if (window.posthog && sessionData) {
            try {
                const session = JSON.parse(sessionData);
                posthog.identify(session.srn, {
                    srn: session.srn,
                    name: session.profile?.name || 'Unknown',
                    branch: session.profile?.branch,
                    semester: session.profile?.semester,
                    is_pwa: window.matchMedia('(display-mode: standalone)').matches
                });
                posthog.capture('pdf_viewed', {
                    pdf_path: pdfPath,
                    pdf_title: title || 'Unknown',
                    file_name: pdfPath.split('/').pop(),
                    subject: extractSubjectFromPath(pdfPath),
                    unit: extractUnitFromPath(pdfPath),
                    view_timestamp: new Date().toISOString(),
                    referrer: document.referrer,
                    is_pwa: window.matchMedia('(display-mode: standalone)').matches
                });
            } catch (error) {
                console.error('PostHog tracking error:', error);
            }
        }
    }

    // Extract subject from file path
    function extractSubjectFromPath(path) {
        const match = path.match(/\/(wd|cfp|mp|mfca|pce)\//i);
        return match ? match[1].toUpperCase() : 'Unknown';
    }

    // Extract unit from file path
    function extractUnitFromPath(path) {
        const match = path.match(/unit[-_]?(\d+)/i);
        return match ? `Unit ${match[1]}` : 'Unknown';
    }

    // Track page view
    if (window.posthog) {
        posthog.capture('$pageview', {
            page_type: 'pdf_viewer',
            pdf_path: pdfPath,
            title: title,
            is_pwa: window.matchMedia('(display-mode: standalone)').matches
        });
    }

    // Load PDF viewer if session is valid (login.js will handle session check)
    // You may want to expose a global callback for login.js to call loadPdfViewer() after successful login
    window.loadPdfViewer = loadPdfViewer;

    // Optionally, try to load PDF if already logged in
    if (sessionStorage.getItem('logged_in') === 'true') {
        loadPdfViewer();
    }
});
</script>
{% endblock main_content %}