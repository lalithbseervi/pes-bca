{% extends "base.html" %}

{% block main_content %}
<div id="pdf-container">
    <div class="loading-message">
        <h2>Loading document...</h2>
        <p>Verifying access permissions...</p>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Get URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    const pdfPath = urlParams.get('file');
    const sessionToken = urlParams.get('token');
    const sessionExpiry = urlParams.get('expires');
    const title = urlParams.get('title');

    if (title) {
        document.title = title;
    }
    
    if (!pdfPath) {
        document.getElementById('pdf-container').innerHTML = '<h2>Error: No file specified</h2>';
        return;
    }

    // Session validation logic (same as before)
    let isValidSession = false;
    
    if (sessionToken && sessionExpiry) {
        const now = new Date().getTime();
        const expiryTime = parseInt(sessionExpiry);
        isValidSession = now < expiryTime;
    } else {
        const sessionData = sessionStorage.getItem('user_session');
        if (sessionData) {
            try {
                const session = JSON.parse(sessionData);
                const now = new Date();
                const expiresAt = new Date(session.expiresAt);
                isValidSession = now < expiresAt;
            } catch (error) {
                isValidSession = false;
            }
        }
    }

    if (!isValidSession) {
        window.location.href = '/';
        return;
    }

    // Use locally hosted PDF.js
    const pdfViewerUrl = `/pdfjs/web/viewer.html?file=${encodeURIComponent(pdfPath)}`;
    
    document.getElementById('pdf-container').innerHTML = `
        <div style="width: 100%; height: 90vh;">
            <iframe src="${pdfViewerUrl}" 
                    style="width: 100%; height: 100%; border: none;"
                    allow="fullscreen">
                <p>Loading PDF viewer...</p>
            </iframe>
        </div>
    `;
});
</script>
{% endblock main_content %}