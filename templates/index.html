{% extends "base.html" %}
{% macro home_page(section) %}
<!-- Preload critical CSS to reduce render-blocking -->
<link rel="preload" href="/css/index.css?v={{ config.extra.sw_version }}" as="style" onload="this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="/css/index.css?v={{ config.extra.sw_version }}"></noscript>
<link rel="preload" href="/css/alerts.css?v={{ config.extra.sw_version }}" as="style" onload="this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="/css/alerts.css?v={{ config.extra.sw_version }}"></noscript>
<script defer src="/js/openLinkHandler.js?v={{ config.extra.sw_version }}"></script>
<style>
  .search-filters {
    background: rgba(31, 41, 55, 0.5);
    border: 1px solid rgba(55, 65, 81, 0.5);
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 1.5rem;
    backdrop-filter: blur(10px);
  }
  
  .filter-row {
    display: flex;
    gap: 2rem;
    flex-wrap: wrap;
    align-items: flex-end;
  }
  
  .filter-field {
    flex: 1;
    min-width: 200px;
  }
  
  .filter-field label {
    display: block;
    margin-bottom: 0.25rem;
    font-size: 0.875rem;
    color: #9ca3af;
    font-weight: 500;
  }
  
  .filter-field input {
      width: 100%;
      padding: 0.5rem;
      border: 1px solid rgba(55, 65, 81, 0.8);
      border-radius: 6px;
      font-size: 0.875rem;
      background: rgba(17, 24, 39, 0.5);
      color: #f3f4f6;
      transition: border-color 0.3s ease, background 0.2s ease;
  }
  
  .filter-field input::placeholder {
    color: #6b7280;
  }
  
  .filter-field input:focus {
      outline: none;
      /* Animate the entire border to the accent color */
      border-color: #10b981;
  }
  
  .filter-btn {
    padding: 0.5rem 1rem;
    background: #10b981;
    color: white;
    border: none;
    border-radius: 6px;
    font-weight: 600;
    cursor: pointer;
    font-size: 0.875rem;
  }
  
  .filter-btn:hover {
    background: #059669;
  }
  
  .clear-btn {
    background: #6b7280;
  }
  
  .clear-btn:hover {
    background: #4b5563;
  }
  
  .no-results {
    text-align: center;
    padding: 2rem;
    color: #9ca3af;
    font-style: italic;
  }
</style>
<main>
    {% include "components/login.html" %}
    
    <!-- Main content -->
    <article>
        <section class="body" style="display: none;">
            <br>
            <div class="alerts">
                <div class="alert alert-info">
                    <div class="alert-type">
                        <strong>Disclaimer</strong>
                    </div>
                    <div class="alert-content">
                        This site is in no way affiliated to PESU Academy or pes.edu.
                        All content is borrowed from PESU Academy unless explicitly stated.
                    </div>
                </div>
            </div><br>
            {{ post_macros::page_header(title=section.title) }}
            {{ section.content | safe }}
            
            <!-- Search and Filter Section -->
            <div class="search-filters">
              <div class="filter-row">
                <div class="filter-field">
                  <input type="text" id="search-input" placeholder="Search by filename or title...">
                </div>
                <div style="display: flex; gap: 0.5rem;">
                  <button class="filter-btn" onclick="applyFilters()">Search</button>
                  <button class="filter-btn clear-btn" onclick="clearFilters()">Clear</button>
                </div>
              </div>
            </div>
            
            <div id="loading-resources" class="loading-message" style="text-align: center; padding: 2rem;">
              <p>Loading resources...</p>
            </div>
            
            <div id="no-results" class="no-results" style="display: none;">
              No results found. Try different search terms.
            </div>
            
            <div class="parent-parent" id="content-area" style="display: none;">
              <ul class="parent" style="list-style-type: none;" id="resources-list">
                <!-- Resources will be dynamically loaded here -->
              </ul>
            </div>
        </section>
    </article>
</main>
<p id="last-updated">Last Updated: Loading...</p>
<script type="module">
import { API_BASE_URL } from '/js/utils.js?v={{ config.extra.sw_version }}';
import { initHomeSearchSuggest } from '/js/init-search-suggest.js?v={{ config.extra.sw_version }}';

let allResources = [];

// Load resources from API
async function loadResources() {
    try {
        const loadingEl = document.getElementById('loading-resources');
        const contentArea = document.getElementById('content-area');
        
        const response = await fetch(`${API_BASE_URL}/api/resources`);
        if (!response.ok) throw new Error('Failed to fetch resources');
        
        const data = await response.json();
        allResources = data.resources || [];
        
        // Group resources by semester
        const grouped = groupResources(allResources);
        
        // Render the tree structure
        renderResourceTree(grouped);
        
        // Hide loading, show content
        loadingEl.style.display = 'none';
        contentArea.style.display = 'block';
        
        // Update last updated timestamp with most recent resource
        const mostRecentResource = allResources.reduce((latest, resource) => {
            if (!resource.created_at) return latest;
            const resourceDate = new Date(resource.created_at);
            const latestDate = latest ? new Date(latest.created_at) : null;
            return (!latestDate || resourceDate > latestDate) ? resource : latest;
        }, null);
        
        const lastUpdatedDate = mostRecentResource?.created_at 
            ? new Date(mostRecentResource.created_at)
            : new Date();
        
        document.getElementById('last-updated').textContent = 
            `Last Updated: ${lastUpdatedDate.toLocaleString('en-GB', { 
                day: '2-digit', 
                month: '2-digit', 
                year: 'numeric', 
                hour: '2-digit', 
                minute: '2-digit', 
                second: '2-digit' 
            })}`;
        
                // Setup details toggle behavior
        setupDetailsToggle();

        // Initialize search suggestions for homepage input
        try {
            const searchInput = document.getElementById('search-input');
            initHomeSearchSuggest(searchInput, allResources, applyFilters);
        } catch (err) {
            console.warn('Search suggest init failed', err);
        }
        
    } catch (error) {
        console.error('Failed to load resources:', error);
        document.getElementById('loading-resources').innerHTML = 
            '<p style="color: #ef4444;">Failed to load resources. Please refresh the page.</p>';
    }
}

// Group resources by semester > subject > unit > resource_type
function groupResources(resources) {
    const grouped = {};
    
    resources.forEach(resource => {
        const semester = resource.semester || 'sem-1';
        const subject = resource.subject || 'unknown';
        const unit = resource.unit || 'General';
        const type = resource.resource_type || 'Miscellaneous';
        
        if (!grouped[semester]) grouped[semester] = {};
        if (!grouped[semester][subject]) grouped[semester][subject] = {};
        if (!grouped[semester][subject][unit]) grouped[semester][subject][unit] = {};
        if (!grouped[semester][subject][unit][type]) grouped[semester][subject][unit][type] = [];
        
        grouped[semester][subject][unit][type].push(resource);
    });
    
    return grouped;
}

// Subject name mapping (kept for index page since it displays all subjects and would require many API calls)
const subjectNames = {
    'cfp': 'Computing Fundamentals with Python',
    'wd': 'Web Design',
    'mfca': 'Mathematical Foundation for Computer Applications',
    'mp': 'Macro Programming',
    'pce': 'Professional Communication and Ethics',
    'ciep': 'CIEP (Constitutional of India, Cyber Law, and Professional Ethics)',
    'c-programming': 'Programming with C',
    'dbms': 'Database Systems',
    'os': 'Platforms and Operating Systems',
    'computer-org': 'Computer Organization and Architecture',
    'pd': 'Personality Development',
    'evs': 'Environmental Studies',
    'dsa': 'Data Structures',
    'oop': 'Object Oriented Programming',
    'data-comm': 'Data Communication',
    'elec1': 'Elective I',
    'digital-marketing': 'Digital Marketing',
    'algorithms': 'Design of Algorithms',
    'web-app-design': 'Web Application Design',
    'software-engg': 'Software Engineering',
    'elec2': 'Elective II',
    'cyber-law': 'Cyber Law',
    'waf': 'Web Application Framework',
    'stats': 'Statistics and R Programming',
    'elec3': 'Elective III',
    'elec4': 'Elective IV',
    'entrepreneurship': 'Entrepreneurship',
    'cloud': 'Cloud Technologies',
    'intern': 'Internship/Swayam/MOOC',
    'dsa': 'Data Structures and Algorithms'
};

// Render the complete tree structure
function renderResourceTree(grouped) {
    const list = document.getElementById('resources-list');
    list.innerHTML = '';
    
    // Sort semesters
    const semesters = Object.keys(grouped).sort();
    
    semesters.forEach((semester, semIndex) => {
        const semesterLi = document.createElement('li');
        const semesterDetails = document.createElement('details');
        semesterDetails.open = semIndex === 0; // Open first semester by default
        
        const semesterSummary = document.createElement('summary');
        semesterSummary.textContent = formatSemesterName(semester);
        semesterDetails.appendChild(semesterSummary);
        
        const subjectsList = document.createElement('ul');
        
        // Sort subjects
        const subjects = Object.keys(grouped[semester]).sort();
        
        subjects.forEach(subject => {
            const subjectLi = document.createElement('li');
            subjectLi.id = `subject-${subject}`;
            
            const subjectDetails = document.createElement('details');
            subjectDetails.open = false; // Keep subjects closed by default
            
            const subjectSummary = document.createElement('summary');
            subjectSummary.innerHTML = `
                ${subjectNames[subject] || subject.toUpperCase()}
                <sup><a href="/sem-${semester.split('-')[1]}/${subject}/" style="border-bottom: none;"><svg width="1em" height="1em" viewBox="0 0 24 30" fill="currentColor" style="vertical-align:middle; margin-left: -0.25em"><path class="cls-1" d="m21,12v6c0,1.6543-1.3457,3-3,3H6c-1.6543,0-3-1.3457-3-3V6c0-1.6543,1.3457-3,3-3h6c.55273,0,1,.44775,1,1s-.44727,1-1,1h-6c-.55176,0-1,.44873-1,1v12c0,.55127.44824,1,1,1h12c.55176,0,1-.44873,1-1v-6c0-.55225.44727-1,1-1s1,.44775,1,1Zm-1-9h-4c-.55273,0-1,.44775-1,1s.44727,1,1,1h1.58594l-9.29297,9.29297c-.39062.39062-.39062,1.02344,0,1.41406.19531.19531.45117.29297.70703.29297s.51172-.09766.70703-.29297l9.29297-9.29297v1.58594c0,.55225.44727,1,1,1s1-.44775,1-1v-4c0-.55225-.44727-1-1-1Z"/></svg></a></sup>
            `;
            subjectDetails.appendChild(subjectSummary);
            
            const unitsList = document.createElement('ul');
            
            // Sort units
            const units = Object.keys(grouped[semester][subject]).sort((a, b) => {
                // Numeric sort for units
                const aNum = parseInt(a);
                const bNum = parseInt(b);
                if (!isNaN(aNum) && !isNaN(bNum)) return aNum - bNum;
                return a.localeCompare(b);
            });
            
            units.forEach(unit => {
                const unitLi = document.createElement('li');
                const unitDetails = document.createElement('details');
                unitDetails.open = false; // Keep units closed by default
                
                const unitSummary = document.createElement('summary');
                unitSummary.textContent = (unit === 'all') ? `Applicable to all Units` : `Unit ${unit}`;
                unitDetails.appendChild(unitSummary);
                
                const typesList = document.createElement('ul');
                
                // Sort resource types
                const types = Object.keys(grouped[semester][subject][unit]).sort();
                
                types.forEach(type => {
                    const typeLi = document.createElement('li');
                    const typeDetails = document.createElement('details');
                    typeDetails.open = false;
                    
                    const typeSummary = document.createElement('summary');
                    typeSummary.textContent = type;
                    typeDetails.appendChild(typeSummary);
                    
                    const resourcesList = document.createElement('ul');
                    
                    // Sort resources by leading number in filename
                    const resources = grouped[semester][subject][unit][type].sort((a, b) => {
                        const aFilename = a.filename || '';
                        const bFilename = b.filename || '';
                        
                        // Extract leading number from filename (handles 1, 01, 001, etc.)
                        const aMatch = aFilename.match(/^(\d+)/);
                        const bMatch = bFilename.match(/^(\d+)/);
                        
                        const aNum = aMatch ? parseInt(aMatch[1]) : 999999;
                        const bNum = bMatch ? parseInt(bMatch[1]) : 999999;
                        
                        return aNum - bNum;
                    });
                    
                    resources.forEach(resource => {
                        const resourceLi = document.createElement('li');
                        const link = document.createElement('a');
                        const title = resource.link_title || resource.filename;
                        // Build semantic URL; special-case unit-all to include resource type
                        const semesterNumber = semester.match(/\d+/)[0];
                        const filename = resource.filename || '';
                        let filePath;
                        if (unit === 'all') {
                            // Include type segment for all-units resources
                            filePath = `sem-${semesterNumber}/${subject}/${type}/unit-all/${encodeURIComponent(filename)}`;
                        } else {
                            filePath = `sem-${semesterNumber}/${subject}/unit-${unit}/${encodeURIComponent(filename)}`;
                        }
                        // Encode the entire filePath when placing into query string to avoid breaking on & and spaces
                        link.href = `/pdf-viewer?file=${encodeURIComponent(filePath)}&title=${encodeURIComponent(title)}`;
                        link.textContent = title;
                        link.setAttribute('data-filename', resource.filename);
                        link.setAttribute('data-title', resource.link_title || '');
                        resourceLi.appendChild(link);
                        resourcesList.appendChild(resourceLi);
                    });
                    
                    typeDetails.appendChild(resourcesList);
                    typeLi.appendChild(typeDetails);
                    typesList.appendChild(typeLi);
                });
                
                unitDetails.appendChild(typesList);
                unitLi.appendChild(unitDetails);
                unitsList.appendChild(unitLi);
            });
            
            subjectDetails.appendChild(unitsList);
            subjectLi.appendChild(subjectDetails);
            subjectsList.appendChild(subjectLi);
        });
        
        semesterDetails.appendChild(subjectsList);
        semesterLi.appendChild(semesterDetails);
        list.appendChild(semesterLi);
    });
}

function formatSemesterName(sem) {
    const match = sem.match(/sem-(\d+)/i);
    if (match) return `Semester ${match[1]}`;
    return sem;
}

function setupDetailsToggle() {
    document.querySelectorAll('details').forEach(function (details) {
        details.addEventListener('toggle', function () {
            if (!details.open) {
                details.querySelectorAll('details').forEach(function (child) {
                    child.open = false;
                });
            }
        });
    });
}

// Search and filter functionality
    function applyFilters() {
        const searchTerm = document.getElementById('search-input').value.toLowerCase().trim();
        const contentArea = document.getElementById('content-area');
        const noResults = document.getElementById('no-results');
        
        if (!searchTerm) {
            clearFilters();
            return;
        }
        
        let foundAny = false;
        
        // Search through all links
        const allLinks = contentArea.querySelectorAll('a');
        allLinks.forEach(link => {
            const text = link.textContent.toLowerCase();
            const href = link.getAttribute('href') ? link.getAttribute('href').toLowerCase() : '';
            const matches = text.includes(searchTerm) || href.includes(searchTerm);
            
            // Find the closest parent li
            let listItem = link.closest('li');
            if (listItem) {
                if (matches) {
                    listItem.style.display = '';
                    foundAny = true;
                    
                    // Show all parent details elements
                    let parent = listItem.parentElement;
                    while (parent) {
                        if (parent.tagName === 'DETAILS') {
                            parent.open = true;
                            parent.style.display = '';
                        }
                        if (parent.tagName === 'LI') {
                            parent.style.display = '';
                        }
                        parent = parent.parentElement;
                    }
                } else {
                    // Only hide leaf items (items without nested details)
                    const hasNestedDetails = listItem.querySelector('details');
                    if (!hasNestedDetails) {
                        listItem.style.display = 'none';
                    }
                }
            }
        });
        
        // Hide empty details sections
        contentArea.querySelectorAll('details').forEach(details => {
            const visibleItems = Array.from(details.querySelectorAll(':scope > ul > li')).filter(li => {
                return li.style.display !== 'none';
            });
            
            if (visibleItems.length === 0) {
                details.style.display = 'none';
            } else {
                details.style.display = '';
            }
        });
        
        noResults.style.display = foundAny ? 'none' : 'block';
    }
    
    function clearFilters() {
        document.getElementById('search-input').value = '';
        const contentArea = document.getElementById('content-area');
        const noResults = document.getElementById('no-results');
        
        // Show all items
        contentArea.querySelectorAll('li, details').forEach(el => {
            el.style.display = '';
        });

        // Reset details to initial state: open first semester, close others
        const semesterDetails = Array.from(contentArea.querySelectorAll(':scope > ul > li > details'));
        semesterDetails.forEach((semDetails, idx) => {
            semDetails.open = idx === 0; // open only first semester

            // Close subjects and units inside each semester for a clean reset
            semDetails.querySelectorAll(':scope > ul > li > details').forEach(subjectDetails => {
                subjectDetails.open = false;
                // Also close deeper nested details
                subjectDetails.querySelectorAll('details').forEach(d => d.open = false);
            });
        });



        noResults.style.display = 'none';
    }
    
    function getDetailsLevel(element) {
        let level = 0;
        let parent = element.parentElement;
        while (parent) {
            if (parent.tagName === 'DETAILS') {
                level++;
            }
            parent = parent.parentElement;
        }
        return level;
    }
    
    // Search on Enter key
    document.addEventListener('DOMContentLoaded', function() {
        const searchInput = document.getElementById('search-input');
        if (searchInput) {
            searchInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    applyFilters();
                }
            });
        }
        
        // Load resources when page loads
        loadResources();
    });

    // Expose functions to global scope so inline handlers (onclick) work
    // The page uses inline onclick attributes for the search buttons.
    window.applyFilters = applyFilters;
    window.clearFilters = clearFilters;
</script>
{% endmacro home_page %}

{% block main_content %}
{{ self::home_page(section=section) }}
{% endblock main_content %}