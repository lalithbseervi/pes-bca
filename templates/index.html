{% extends "base.html" %}
{% macro home_page(section) %}
<link rel="stylesheet" href="/css/index.css">
<link rel="stylesheet" href="/css/alerts.css">
<link rel="stylesheet" href="/css/loading_animation.css">
<script>
    !function(t,e){var o,n,p,r;e.__SV||(window.posthog=e,e._i=[],e.init=function(i,s,a){function g(t,e){var o=e.split(".");2==o.length&&(t=t[o[0]],e=o[1]),t[e]=function(){t.push([e].concat(Array.prototype.slice.call(arguments,0)))}}(p=t.createElement("script")).type="text/javascript",p.crossOrigin="anonymous",p.async=!0,p.src=s.api_host.replace(".i.posthog.com","-assets.i.posthog.com")+"/static/array.js",(r=t.getElementsByTagName("script")[0]).parentNode.insertBefore(p,r);var u=e;for(void 0!==a?u=e[a]=[]:a="posthog",u.people=u.people||[],u.toString=function(t){var e="posthog";return"posthog"!==a&&(e+="."+a),t||(e+=" (stub)"),e},u.people.toString=function(){return u.toString(1)+".people (stub)"},o="init Ce js Ls Te Fs Ds capture Ye calculateEventProperties Us register register_once register_for_session unregister unregister_for_session Ws getFeatureFlag getFeatureFlagPayload isFeatureEnabled reloadFeatureFlags updateEarlyAccessFeatureEnrollment getEarlyAccessFeatures on onFeatureFlags onSurveysLoaded onSessionId getSurveys getActiveMatchingSurveys renderSurvey displaySurvey canRenderSurvey canRenderSurveyAsync identify setPersonProperties group resetGroups setPersonPropertiesForFlags resetPersonPropertiesForFlags setGroupPropertiesForFlags resetGroupPropertiesForFlags reset get_distinct_id getGroups get_session_id get_session_replay_url alias set_config startSessionRecording stopSessionRecording sessionRecordingStarted captureException loadToolbar get_property getSessionProperty Bs zs createPersonProfile Hs Ms Gs opt_in_capturing opt_out_capturing has_opted_in_capturing has_opted_out_capturing get_explicit_consent_status is_capturing clear_opt_in_out_capturing Ns debug L qs getPageViewId captureTraceFeedback captureTraceMetric".split(" "),n=0;n<o.length;n++)g(u,o[n]);e._i.push([i,s,a])},e.__SV=1)}(document,window.posthog||[]);
    posthog.init('phc_78cRhH8qoYmTyUHbMXdUxqrFPFfrdVp3yxzK0gdqB6Q', {
        api_host: 'https://us.i.posthog.com',
        defaults: '2025-05-24',
        person_profiles: 'identified_only', // or 'always' to create profiles for anonymous users as well
    })
</script>
<main>
    <!-- Loading overlay -->
    <div id="loading-overlay" class="loading-overlay">
        <div class="loading-content">
            <div class="spinner"></div>
            <div class="loading-text">Verifying details<span class="loading-dots"></span></div>
        </div>
    </div>
    
    <article>
        <section class="body" style="display: none;">
            <br>
            <div class="alerts">
                <div class="alert alert-info">
                    <div class="alert-type">
                        <strong>Disclaimer</strong>
                    </div>
                    <div class="alert-content">
                        This site is in no way affiliated to PESU Academy or pes.edu.
                        All content is borrowed from PESU Academy unless explicitly stated.
                    </div>
                </div>
            </div><br>
            <div class="alerts">
                <div class="alert alert-error">
                    <div class="alert-type">
                        <strong>Upcoming: ISA-1</strong>
                    </div>
                    <div class="alert-content">
                        <a href="/time_tables/BCA_1st_3rd__5th_sem_ISA-1_TT.pdf" target="_blank" rel="noopener noreferrer">Time Table for ISA-1</a>
                    </div>
                </div>
            </div>
            {{ post_macros::page_header(title=section.title) }}
            {{ section.content | safe }}
            <div class="parent-parent">
            <ul class="parent" style="list-style-type: none;">
                <li>
                    {% include 'web_design.html' %}
                </li>
                <li>
                    {% include 'cfp.html' %}
                </li>
                <li>
                    {% include 'mp.html' %}
                </li>
                <li>
                    {% include 'mfca.html' %}
                </li>
                <li>
                    {% include 'pce.html' %}
                </li>
            </ul>
            </div>
        </section>
    </article>
</main>
<script>
document.addEventListener('DOMContentLoaded', async function() {
    // login script
    const content = document.getElementsByClassName('body')[0];

    if (!sessionStorage.logged_in) {
        let srn = prompt("Enter your SRN/PRN: ");
        let pwd = prompt("Enter your password: ");

        if (!srn || !pwd) return;
        
        // Show loading overlay
        const loadingOverlay = document.getElementById('loading-overlay');
        loadingOverlay.style.display = 'flex';
        
        try {
            const res = await fetch(('https://cors-proxy.devpages.workers.dev/?url=' + encodeURIComponent('https://pesu-auth.onrender.com/authenticate')), {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    username: srn,
                    password: pwd,
                    profile: true,
                    fields: [
                        'branch',
                        'semester',
                        'name'
                    ]
                })
            });

            // Hide loading overlay
            loadingOverlay.style.display = 'none';

            if (res.ok) {
                const data = await res.json();

                if (data.profile.branch == 'Bachelor of Computer Applications' && data.profile.semester == 'Sem-1') {
                    sessionStorage.setItem('user_details', JSON.stringify(data));
                    sessionStorage.setItem('logged_in', true)

                    // Enhanced PostHog user profiling
                    if (window.posthog) {
                        posthog.identify(srn, {
                            srn: srn,
                            name: data.profile.name || 'Unknown',
                            branch: data.profile.branch,
                            semester: data.profile.semester,
                            login_date: new Date().toISOString(),
                            user_type: 'student'
                        });

                        // Track login event
                        posthog.capture('user_login', {
                            srn: srn,
                            name: data.profile.name || 'Unknown',
                            branch: data.profile.branch,
                            semester: data.profile.semester,
                            login_method: 'pesu_auth',
                            timestamp: new Date().toISOString()
                        });
                    }

                    alert(`Welcome ${srn}!`)
                    content.style.display = 'block';
                }
                else {
                    content.remove();
                    alert("You cannot access this content.")
                };
            }
            else if (res.status == 500 || res.status == 502 || res.status == 503) {
                err_message = document.createElement('div');
                err_message.innerHTML = `<h1 style=\"color: red; font-style: Helvetica, sans-serif;\">A 3rd party service is currently down. Please try again later.<br>Status Code: ${res.status}</h1>`;
                content.replaceWith(err_message);
                content.style.display = 'block';
                return;
            }
            else {
                content.remove()
                alert("Invalid PRN/SRN or password.");
            }
        } catch (error) {
            // Hide loading overlay on error
            loadingOverlay.style.display = 'none';
            console.error('Authentication error:', error);
            alert('Network error. Please check your connection and try again.');
        }
    }
    
    if (sessionStorage.getItem('logged_in')) {
        // Re-identify user from stored session data
        const userDetails = JSON.parse(sessionStorage.getItem('user_details'));
        if (userDetails && window.posthog) {
            posthog.identify(userDetails.username || userDetails.srn, {
                srn: userDetails.username || userDetails.srn,
                name: userDetails.profile?.name || 'Unknown',
                branch: userDetails.profile?.branch,
                semester: userDetails.profile?.semester,
                session_restored: true,
                user_type: 'student'
            });
        }
        content.style.display = 'block';
    }
});
</script>
<script>
    // Close all child <details> when a parent <details> is closed
    document.addEventListener('DOMContentLoaded', function () {
        document.querySelectorAll('details').forEach(function (details) {
            details.addEventListener('toggle', function () {
                if (!details.open) {
                    details.querySelectorAll('details').forEach(function (child) {
                        child.open = false;
                    });
                }
            });
        });
    });
</script>
{% endmacro home_page %}

{% block main_content %}
{{ self::home_page(section=section) }}
{% endblock main_content %}