{% extends "base.html" %}

{% block main_content %}
<meta name="robots" content="noindex,nofollow" />
<link rel="stylesheet" href="/css/admin.css?v={{ config.extra.sw_version }}">

<style>
  /* Page-specific styles only */
  /* Neutralize theme heading prefixes and ensure readable contrast for admin surface */
  .admin-page h1::before,
  .admin-page h2::before,
  .admin-page h3::before,
  .admin-page h4::before,
  .admin-page h5::before,
  .admin-page h6::before {
    content: none !important;
  }

  .admin-page h1,
  .admin-page h2,
  .admin-page h3,
  .admin-page h4,
  .admin-page h5,
  .admin-page h6 {
    font-family: system-ui, -apple-system, "Segoe UI", sans-serif;
    color: #0f172a;
    letter-spacing: -0.01em;
  }

  .admin-page {
    background: #f5f7fb;
    padding: 2rem 1.25rem;
    border-radius: 12px;
  }

  .admin-section {
    background: #ffffff;
    border-color: #e5e7eb;
    box-shadow: 0 8px 24px rgba(15, 23, 42, 0.06);
  }

  .admin-section h2,
  .admin-section h3,
  .admin-section h4 {
    color: #0f172a;
  }

  .admin-table th,
  .admin-table td {
    color: #111827;
    background: #ffffff;
  }

  /* Subjects list readability */
  #subjects-list table {
    background: #ffffff;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    overflow: hidden;
  }

  #subjects-list thead th {
    background: #e0f2fe;
    color: #0f172a;
    font-weight: 700;
    border-bottom: 1px solid #cbd5e1;
  }

  #subjects-list tbody td {
    color: #111827;
    border-bottom: 1px solid #eef2ff;
  }

  #subjects-list tbody tr:nth-child(even) td {
    background: #f8fafc;
  }

  #subjects-list tbody tr:hover td {
    background: #e0f2fe;
  }

  #subjects-list h3,
  #subjects-list h4 {
    margin: 0;
    color: #0f172a;
  }

  #subjects-list .admin-btn-action-delete {
    background: #dc2626;
    color: #fff;
  }

  #subjects-list h3,
  #subjects-list h4 {
    margin: 0;
  }

  .auth-required {
    text-align: center;
    padding: 3rem 1rem;
  }

  .auth-required p {
    margin-bottom: 1rem;
    color: var(--admin-text-secondary);
  }

  .loading {
    text-align: center;
    padding: 2rem;
    color: var(--admin-text-secondary);
  }

  .empty-state {
    text-align: center;
    padding: 3rem 1rem;
    color: var(--admin-text-secondary);
  }

  .tab-content {
    display: none;
  }

  .tab-content.active {
    display: block;
  }

  iframe {
    width: 100%;
    height: calc(100vh - 200px);
    border: 1px solid var(--admin-border);
    border-radius: 8px;
  }

  .badge {
    display: inline-block;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: 600;
  }

  .badge-primary {
    background: #dbeafe;
    color: #1e40af;
  }

  .badge-success {
    background: #d1fae5;
    color: #065f46;
  }

  .badge-warning {
    background: #fef3c7;
    color: #92400e;
  }

  #page-info {
    color: var(--admin-text-primary-light);
  }
</style>

<div class="admin-page">
  <div id="auth-required" class="auth-required" style="display: none;">
    <h2>Authentication Required</h2>
    <p>You must be logged in to access the admin panel.</p>
    <a href="/upload" class="admin-btn admin-btn-primary">Go to Login</a>
  </div>

  <div id="admin-content" style="display: none;">
    <div class="admin-header">
      <h1>Admin Panel</h1>
      <a href="/" class="admin-btn admin-btn-secondary">← Back to Home</a>
    </div>

    <div id="message"></div>

    <div class="admin-tabs">
      <button class="admin-tab active" data-tab="resources">Resources</button>
      <button class="admin-tab" data-tab="subjects">Subjects Config</button>
      <button class="admin-tab" data-tab="status">Status Page</button>
      <button class="admin-tab" data-tab="settings">Settings</button>
    </div>

    <!-- Resources Tab -->
    <div class="tab-content active" id="tab-resources">
      <div class="admin-section">
        <h2>Manage Resources</h2>
        
        <div class="admin-filters">
          <div class="admin-filter-group">
            <label>Search</label>
            <input type="text" id="search" placeholder="Search by filename or title...">
          </div>
          
          <div class="admin-filter-group">
            <label>Subject</label>
            <select id="filter-subject">
              <option value="">All Subjects</option>
            </select>
          </div>
          
          <div class="admin-filter-group">
            <label>Semester</label>
            <select id="filter-semester">
              <option value="">All Semesters</option>
            </select>
          </div>
          
          <div class="admin-filter-group">
            <label>Type</label>
            <select id="filter-type">
              <option value="">All Types</option>
            </select>
          </div>
          
          <div class="admin-filter-group filter-button-container">
            <button class="admin-btn admin-btn-primary" id="apply-filters">Apply Filters</button>
          </div>
        </div>

        <div id="resources-loading" class="loading" style="display: none;">
          <p>Loading resources...</p>
        </div>

        <div id="resources-empty" class="empty-state" style="display: none;">
          <p>No resources found.</p>
        </div>

        <div class="table-container" id="resources-table" style="display: none;">
          <table class="admin-table">
            <thead>
              <tr>
                <th>Filename</th>
                <th>Title</th>
                <th>Subject</th>
                <th>Semester</th>
                <th>Type</th>
                <th>Unit</th>
                <th>Size</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="resources-tbody">
            </tbody>
          </table>
        </div>

        <div class="admin-pagination" id="pagination" style="display: none;">
          <button class="admin-page-btn" id="prev-page">Previous</button>
          <span id="page-info"></span>
          <button class="admin-page-btn" id="next-page">Next</button>
        </div>
      </div>
    </div>

    <!-- Subjects Config Tab -->
    <div class="tab-content" id="tab-subjects">
      <div class="admin-section">
        <h2>Manage Subjects Configuration</h2>
        <p style="color: var(--admin-text-secondary); margin-bottom: 1.5rem;">
          Manage course subjects and semesters for upload form dropdowns.
        </p>

        <!-- Add New Subject Form -->
        <div style="background: var(--admin-bg); padding: 1.5rem; border-radius: 8px; margin-bottom: 2rem;">
          <h3 style="margin-bottom: 1rem;">Add New Subject</h3>
          
          <form id="add-subject-form" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
            <div class="admin-form-group">
              <label for="subject-course">Course *</label>
              <input type="text" id="subject-course" placeholder="e.g., CA, CS, EC" required>
            </div>
            
            <div class="admin-form-group">
              <label for="subject-semester">Semester *</label>
              <input type="text" id="subject-semester" placeholder="e.g., Semester-1" required>
            </div>
            
            <div class="admin-form-group">
              <label for="subject-code">Subject Code *</label>
              <input type="text" id="subject-code" placeholder="e.g., cfp" required>
            </div>
            
            <div class="admin-form-group">
              <label for="subject-name">Subject Name *</label>
              <input type="text" id="subject-name" placeholder="e.g., Computing Fundamentals" required>
            </div>
            
            <div class="admin-form-group">
              <label for="subject-order">Display Order</label>
              <input type="number" id="subject-order" placeholder="0" value="0">
            </div>

            <div style="display: flex; align-items: flex-end;">
              <button type="submit" class="admin-btn admin-btn-primary" style="width: 100%;">Add Subject</button>
            </div>
          </form>
        </div>

        <div id="subjects-loading" class="loading" style="display: none;">
          <p>Loading subjects configuration...</p>
        </div>

        <div id="subjects-empty" class="empty-state" style="display: none;">
          <p>No subjects configured yet.</p>
        </div>

        <!-- Subjects List by Course/Semester -->
        <div id="subjects-content" style="display: none;">
          <div id="subjects-list"></div>
        </div>

        <div id="subjects-message" style="margin-top: 1rem;"></div>
      </div>
    </div>

    <!-- Status Page Tab -->
    <div class="tab-content" id="tab-status">
      <iframe src="/status-admin" id="status-frame"></iframe>
    </div>

    <!-- Settings Tab -->
    <div class="tab-content" id="tab-settings">
      <div id="settings-loading" class="loading" style="display: none;">
        <p>Loading configuration...</p>
      </div>

      <div id="settings-error" class="empty-state" style="display: none; color: #dc2626;">
        <p>Failed to load configuration.</p>
      </div>

      <div id="settings-content" style="display: none;">
        <!-- Rate Limit Configuration -->
        <div class="admin-section">
          <h2>Rate Limit Configuration</h2>
          <p style="color: var(--admin-text-secondary); margin-bottom: 1.5rem;">
            Configure the maximum number of file download requests allowed per 10-minute window.
          </p>

          <div class="admin-filter-group" style="max-width: 400px;">
            <label for="max-requests-input">Max Requests per Window</label>
            <input 
              type="number" 
              id="max-requests-input" 
              min="1" 
              max="1000" 
              step="1"
              placeholder="10"
              style="padding: 0.75rem; font-size: 1rem;"
            >
            <small style="color: var(--admin-text-secondary); display: block; margin-top: 0.5rem;">
              Valid range: 1-1000 requests. Default is 10 requests per 10-minute window.
            </small>
          </div>
        </div>

        <!-- Maintenance Mode -->
        <div class="admin-section">
          <h2>Maintenance Mode</h2>
          <p style="color: var(--admin-text-secondary); margin-bottom: 1.5rem;">
            Enable maintenance mode to temporarily disable site access with a custom message.
          </p>

          <div class="admin-filter-group" style="max-width: 600px;">
            <label style="display: flex; align-items: center; cursor: pointer;">
              <input 
                type="checkbox" 
                id="maintenance-mode-checkbox"
                style="width: 18px; height: 18px; margin-right: 0.75rem; cursor: pointer;"
              >
              <span>Enable Maintenance Mode</span>
            </label>
          </div>

          <div class="admin-filter-group" style="max-width: 600px; margin-top: 1rem;">
            <label for="maintenance-message-textarea">Maintenance Message</label>
            <textarea 
              id="maintenance-message-textarea"
              rows="4"
              maxlength="500"
              placeholder="We're currently performing scheduled maintenance. Please check back soon."
              style="padding: 0.75rem; font-size: 1rem; font-family: inherit; resize: vertical;"
            ></textarea>
            <small style="color: var(--admin-text-secondary); display: block; margin-top: 0.5rem;">
              This message will be displayed to users when maintenance mode is active. Max 500 characters.
            </small>
          </div>
        </div>

        <!-- Action Buttons -->
        <div class="admin-section">
          <div style="display: flex; gap: 0.75rem; flex-wrap: wrap;">
            <button class="admin-btn admin-btn-primary" id="save-all-settings" style="min-width: 140px;">
              Save All Changes
            </button>
            <button class="admin-btn admin-btn-secondary" id="reset-all-settings">
              Reset All to Defaults
            </button>
          </div>

          <div id="settings-message" style="margin-top: 1rem;"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Replace File Modal -->
<div class="admin-modal" id="replace-modal">
  <div class="admin-modal-content">
    <div class="admin-modal-header">
      <h2>Replace File</h2>
      <button class="admin-modal-close" onclick="closeReplaceModal()">×</button>
    </div>
    <form id="replace-form">
      <input type="hidden" id="replace-id">
      
      <div class="admin-form-group">
        <label>Current File</label>
        <input type="text" id="replace-current" disabled style="opacity: 0.6;">
      </div>
      
      <div class="admin-form-group">
        <label>New File *</label>
        <input type="file" id="replace-file" required accept=".pdf,.jpg,.jpeg,.png,.gif,.doc,.docx,.ppt,.pptx,.xls,.xlsx,.zip,.rar">
        <small style="color: var(--admin-text-secondary); font-size: 0.85rem;">
          Upload a new file to replace the current one. All metadata will be preserved.
        </small>
      </div>
      
      <div id="replace-progress" style="display: none; margin-top: 1rem;">
        <div style="background: var(--admin-bg); border-radius: 4px; overflow: hidden; height: 8px;">
          <div id="replace-progress-bar" style="background: #10b981; height: 100%; width: 0%; transition: width 0.3s;"></div>
        </div>
        <small id="replace-progress-text" style="color: var(--admin-text-secondary); margin-top: 0.5rem; display: block;"></small>
      </div>
      
      <div style="display: flex; gap: 0.5rem; justify-content: flex-end; margin-top: 1.5rem;">
        <button type="button" class="admin-btn admin-btn-secondary" onclick="closeReplaceModal()">Cancel</button>
        <button type="submit" class="admin-btn admin-btn-primary" id="replace-file-btn">Replace File</button>
      </div>
    </form>
  </div>
</div>

<!-- Edit Modal -->
<div class="admin-modal" id="edit-modal">
  <div class="admin-modal-content">
    <div class="admin-modal-header">
      <h2>Edit Resource</h2>
      <button class="admin-modal-close" onclick="closeEditModal()">×</button>
    </div>
    <form id="edit-form">
      <input type="hidden" id="edit-id">
      
      <div class="admin-form-group">
        <label>Filename *</label>
        <input type="text" id="edit-filename" required placeholder="Enter filename (e.g., 01_intro.pdf)">
        <small style="color: var(--admin-text-secondary); font-size: 0.85rem;">Changing this will update all references automatically</small>
      </div>
      
      <div class="admin-form-group">
        <label>Link Title *</label>
        <input type="text" id="edit-link-title" required placeholder="Enter display title for this resource">
      </div>
      
      <div style="display: flex; gap: 0.5rem; justify-content: flex-end; margin-top: 1.5rem;">
        <button type="button" class="admin-btn admin-btn-secondary" onclick="closeEditModal()">Cancel</button>
        <button type="submit" class="admin-btn admin-btn-primary" id="save-edit-btn">Save Changes</button>
      </div>
    </form>
  </div>
</div>

<script type="module">
import { API_BASE_URL, showMessage, formatBytes, checkAdminAuth, getAdminPassphrase } from '/js/utils.js?v={{ config.extra.sw_version }}';

let currentPage = 1;
let currentFilters = {};
let allFilters = {};
let currentResources = [];

async function loadFilters() {
  try {
    const passphrase = getAdminPassphrase();
    const resp = await fetch(`${API_BASE_URL}/api/admin/filters`, {
      headers: {
        'X-Admin-Passphrase': passphrase
      },
      credentials: 'include'
    });
    
    if (!resp.ok) throw new Error('Failed to load filters');
    
    allFilters = await resp.json();
    
    // Populate filter dropdowns
    const subjectSelect = document.getElementById('filter-subject');
    subjectSelect.innerHTML = '<option value="">All Subjects</option>' +
      allFilters.subjects.map(s => `<option value="${s}">${s}</option>`).join('');
    
    const semesterSelect = document.getElementById('filter-semester');
    semesterSelect.innerHTML = '<option value="">All Semesters</option>' +
      allFilters.semesters.map(s => `<option value="${s}">${s}</option>`).join('');
    
    const typeSelect = document.getElementById('filter-type');
    typeSelect.innerHTML = '<option value="">All Types</option>' +
      allFilters.resource_types.map(t => `<option value="${t}">${t}</option>`).join('');
  } catch (e) {
    console.error('Failed to load filters', e);
  }
}

async function loadResources(page = 1) {
  try {
    document.getElementById('resources-loading').style.display = 'block';
    document.getElementById('resources-table').style.display = 'none';
    document.getElementById('resources-empty').style.display = 'none';
    document.getElementById('pagination').style.display = 'none';
    
    const passphrase = getAdminPassphrase();
    const params = new URLSearchParams({
      page: page.toString(),
      limit: '50',
      ...currentFilters
    });
    
    const resp = await fetch(`${API_BASE_URL}/api/admin/resources?${params}`, {
      headers: {
        'X-Admin-Passphrase': passphrase
      },
      credentials: 'include'
    });
    
    if (!resp.ok) throw new Error('Failed to load resources');
    
    const data = await resp.json();
    currentResources = data.resources;
    currentPage = page;
    
    document.getElementById('resources-loading').style.display = 'none';
    
    if (data.resources.length === 0) {
      document.getElementById('resources-empty').style.display = 'block';
      return;
    }
    
    renderResources(data.resources);
    renderPagination(data.pagination);
    
    document.getElementById('resources-table').style.display = 'block';
    document.getElementById('pagination').style.display = 'flex';
  } catch (e) {
    console.error('Failed to load resources', e);
    document.getElementById('resources-loading').style.display = 'none';
    showMessage('Failed to load resources: ' + e.message, 'error');
  }
}

function renderResources(resources) {
  const tbody = document.getElementById('resources-tbody');
  tbody.innerHTML = resources.map(r => `
    <tr>
      <td>${r.filename || 'N/A'}</td>
      <td>${r.link_title || 'N/A'}</td>
      <td><span class="badge badge-primary">${r.subject || 'N/A'}</span></td>
      <td>${r.semester || 'N/A'}</td>
      <td>${r.resource_type || 'N/A'}</td>
      <td>${r.unit !== null ? r.unit : 'N/A'}</td>
      <td>${r.size ? formatBytes(r.size) : 'N/A'}</td>
      <td>
        <div class="admin-actions">
          <button class="admin-btn-action admin-btn-action-edit" onclick="editResource('${r.id}')">Edit</button>
          <button class="admin-btn-action" onclick="replaceFile('${r.id}', '${r.filename}')" style="background: #f59e0b; color: white;">Replace</button>
          <button class="admin-btn-action admin-btn-action-delete" onclick="deleteResource('${r.id}', '${r.filename}')">Delete</button>
        </div>
      </td>
    </tr>
  `).join('');
}

function renderPagination(pagination) {
  document.getElementById('page-info').textContent = 
    `Page ${pagination.page} of ${pagination.pages} (${pagination.total} total)`;
  
  document.getElementById('prev-page').disabled = pagination.page === 1;
  document.getElementById('next-page').disabled = pagination.page === pagination.pages;
}

function editResource(id) {
  const resource = currentResources.find(r => r.id === id);
  if (!resource) return;
  
  document.getElementById('edit-id').value = resource.id;
  document.getElementById('edit-filename').value = resource.filename || '';
  document.getElementById('edit-link-title').value = resource.link_title || '';
  
  document.getElementById('edit-modal').classList.add('active');
}

function closeEditModal() {
  document.getElementById('edit-modal').classList.remove('active');
}

function replaceFile(id, filename) {
  document.getElementById('replace-id').value = id;
  document.getElementById('replace-current').value = filename;
  document.getElementById('replace-file').value = '';
  document.getElementById('replace-progress').style.display = 'none';
  document.getElementById('replace-modal').classList.add('active');
}

function closeReplaceModal() {
  document.getElementById('replace-modal').classList.remove('active');
}

// Make functions globally accessible for onclick handlers
window.editResource = editResource;
window.closeEditModal = closeEditModal;
window.replaceFile = replaceFile;
window.closeReplaceModal = closeReplaceModal;

async function saveEdit(e) {
  e.preventDefault();
  const btn = document.getElementById('save-edit-btn');
  btn.disabled = true;
  
  try {
    const id = document.getElementById('edit-id').value;
    const passphrase = getAdminPassphrase();
    
    const updates = {
      filename: document.getElementById('edit-filename').value.trim(),
      link_title: document.getElementById('edit-link-title').value.trim()
    };
    
    const resp = await fetch(`${API_BASE_URL}/api/admin/resources/${id}`, {
      method: 'PATCH',
      headers: {
        'Content-Type': 'application/json',
        'X-Admin-Passphrase': passphrase
      },
      credentials: 'include',
      body: JSON.stringify(updates)
    });
    
    if (!resp.ok) {
      const error = await resp.json();
      throw new Error(error.error || 'Failed to update resource');
    }
    
    showMessage('Resource updated successfully!');
    closeEditModal();
    await loadResources(currentPage);
  } catch (e) {
    console.error('Failed to update resource', e);
    showMessage('Failed to update resource: ' + e.message, 'error');
  } finally {
    btn.disabled = false;
  }
}

async function handleReplaceFile(e) {
  e.preventDefault();
  const btn = document.getElementById('replace-file-btn');
  const progressDiv = document.getElementById('replace-progress');
  const progressBar = document.getElementById('replace-progress-bar');
  const progressText = document.getElementById('replace-progress-text');
  
  btn.disabled = true;
  progressDiv.style.display = 'block';
  progressBar.style.width = '0%';
  progressText.textContent = 'Preparing upload...';
  
  try {
    const id = document.getElementById('replace-id').value;
    const fileInput = document.getElementById('replace-file');
    const file = fileInput.files[0];
    
    if (!file) {
      throw new Error('Please select a file');
    }
    
    const passphrase = getAdminPassphrase();
    const formData = new FormData();
    formData.append('file', file);
    
    progressText.textContent = 'Uploading...';
    progressBar.style.width = '50%';
    
    const resp = await fetch(`${API_BASE_URL}/api/admin/resources/${id}/file`, {
      method: 'PUT',
      headers: {
        'X-Admin-Passphrase': passphrase
      },
      credentials: 'include',
      body: formData
    });
    
    progressBar.style.width = '90%';
    
    if (!resp.ok) {
      const error = await resp.json();
      throw new Error(error.error || 'Failed to replace file');
    }
    
    progressBar.style.width = '100%';
    progressText.textContent = 'Complete!';
    
    showMessage('File replaced successfully!');
    
    setTimeout(() => {
      closeReplaceModal();
      loadResources(currentPage);
    }, 500);
  } catch (e) {
    console.error('Failed to replace file', e);
    showMessage('Failed to replace file: ' + e.message, 'error');
    progressDiv.style.display = 'none';
  } finally {
    btn.disabled = false;
  }
}

async function deleteResource(id, filename) {
  if (!confirm(`Are you sure you want to delete "${filename}"? This cannot be undone.`)) {
    return;
  }
  
  try {
    const passphrase = getAdminPassphrase();
    
    const resp = await fetch(`${API_BASE_URL}/api/admin/resources/${id}`, {
      method: 'DELETE',
      headers: {
        'X-Admin-Passphrase': passphrase
      },
      credentials: 'include'
    });
    
    if (!resp.ok) {
      const error = await resp.json();
      throw new Error(error.error || 'Failed to delete resource');
    }
    
    showMessage('Resource deleted successfully!');
    await loadResources(currentPage);
  } catch (e) {
    console.error('Failed to delete resource', e);
    showMessage('Failed to delete resource: ' + e.message, 'error');
  }
}

// Make deleteResource globally accessible for onclick handler
window.deleteResource = deleteResource;

// Tab switching
document.querySelectorAll('.admin-tab').forEach(tab => {
  tab.addEventListener('click', () => {
    const tabName = tab.dataset.tab;
    
    document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    
    tab.classList.add('active');
    document.getElementById(`tab-${tabName}`).classList.add('active');
  });
});

// Apply filters
document.getElementById('apply-filters').addEventListener('click', () => {
  currentFilters = {
    search: document.getElementById('search').value || undefined,
    subject: document.getElementById('filter-subject').value || undefined,
    semester: document.getElementById('filter-semester').value || undefined,
    resource_type: document.getElementById('filter-type').value || undefined
  };
  
  // Remove undefined values
  Object.keys(currentFilters).forEach(key => 
    currentFilters[key] === undefined && delete currentFilters[key]
  );
  
  loadResources(1);
});

// Search on Enter
document.getElementById('search').addEventListener('keypress', (e) => {
  if (e.key === 'Enter') {
    document.getElementById('apply-filters').click();
  }
});

// Pagination
document.getElementById('prev-page').addEventListener('click', () => {
  if (currentPage > 1) loadResources(currentPage - 1);
});

document.getElementById('next-page').addEventListener('click', () => {
  loadResources(currentPage + 1);
});

// Edit form
document.getElementById('edit-form').addEventListener('submit', saveEdit);

// Replace file form
document.getElementById('replace-form').addEventListener('submit', handleReplaceFile);

// System Configuration Functions
async function loadSystemConfig() {
  const passphrase = getAdminPassphrase();
  const loadingEl = document.getElementById('settings-loading');
  const errorEl = document.getElementById('settings-error');
  const contentEl = document.getElementById('settings-content');
  
  loadingEl.style.display = 'block';
  errorEl.style.display = 'none';
  contentEl.style.display = 'none';
  
  try {
    const resp = await fetch(`${API_BASE_URL}/api/admin/config`, {
      headers: {
        'X-Admin-Passphrase': passphrase
      },
      credentials: 'include'
    });
    
    if (!resp.ok) {
      throw new Error('Failed to load configuration');
    }
    
    const data = await resp.json();
    
    // Populate form fields
    document.getElementById('max-requests-input').value = data.max_requests_per_window;
    document.getElementById('maintenance-mode-checkbox').checked = data.maintenance_mode;
    document.getElementById('maintenance-message-textarea').value = data.maintenance_message || '';
    
    loadingEl.style.display = 'none';
    contentEl.style.display = 'block';
  } catch (e) {
    console.error('Failed to load system config', e);
    loadingEl.style.display = 'none';
    errorEl.style.display = 'block';
  }
}

async function saveAllSettings() {
  const passphrase = getAdminPassphrase();
  const messageEl = document.getElementById('settings-message');
  const saveBtn = document.getElementById('save-all-settings');
  
  // Validate inputs
  const maxRequests = parseInt(document.getElementById('max-requests-input').value);
  if (isNaN(maxRequests) || maxRequests < 1 || maxRequests > 1000) {
    messageEl.innerHTML = '<p style="color: #dc2626;">Max requests must be between 1 and 1000</p>';
    return;
  }
  
  const maintenanceMessage = document.getElementById('maintenance-message-textarea').value.trim();
  if (maintenanceMessage.length > 500) {
    messageEl.innerHTML = '<p style="color: #dc2626;">Maintenance message must be 500 characters or less</p>';
    return;
  }
  
  saveBtn.disabled = true;
  messageEl.innerHTML = '<p style="color: var(--admin-text-secondary);">Saving configuration...</p>';
  
  try {
    const config = {
      max_requests_per_window: maxRequests,
      maintenance_mode: document.getElementById('maintenance-mode-checkbox').checked,
      maintenance_message: maintenanceMessage
    };
    
    const resp = await fetch(`${API_BASE_URL}/api/admin/config`, {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json',
        'X-Admin-Passphrase': passphrase
      },
      credentials: 'include',
      body: JSON.stringify(config)
    });
    
    if (!resp.ok) {
      const error = await resp.json();
      throw new Error(error.error || 'Failed to save configuration');
    }
    
    const data = await resp.json();
    messageEl.innerHTML = `<p style="color: #059669;">✓ Configuration saved successfully! Updated: ${data.updates.join(', ')}</p>`;
    
    setTimeout(() => {
      messageEl.innerHTML = '';
    }, 5000);
  } catch (e) {
    console.error('Failed to save system config', e);
    messageEl.innerHTML = `<p style="color: #dc2626;">Failed to save: ${e.message}</p>`;
  } finally {
    saveBtn.disabled = false;
  }
}

function resetAllSettings() {
  document.getElementById('max-requests-input').value = 10;
  document.getElementById('maintenance-mode-checkbox').checked = false;
  document.getElementById('maintenance-message-textarea').value = 'We are currently performing scheduled maintenance. Please check back soon.';
  document.getElementById('settings-message').innerHTML = '';
}

// Initialize
document.addEventListener('DOMContentLoaded', async () => {
  console.log('checking for session...')
  const passphrase = await checkAdminAuth();
  if (!passphrase) {
    document.getElementById('auth-required').style.display = 'block';
    return;
  }
  
  document.getElementById('admin-content').style.display = 'block';
  await loadFilters();
  await loadResources(1);
  
  // Settings tab listeners
  document.getElementById('save-all-settings').addEventListener('click', saveAllSettings);
  document.getElementById('reset-all-settings').addEventListener('click', resetAllSettings);
  
  // Load settings when tab is clicked
  document.querySelector('[data-tab="settings"]').addEventListener('click', () => {
    loadSystemConfig();
  });

  // Subjects Config
  async function loadSubjectsConfig() {
    const loadingEl = document.getElementById('subjects-loading');
    const contentEl = document.getElementById('subjects-content');
    const emptyEl = document.getElementById('subjects-empty');
    const messageEl = document.getElementById('subjects-message');
    
    loadingEl.style.display = 'block';
    contentEl.style.display = 'none';
    emptyEl.style.display = 'none';
    messageEl.innerHTML = '';
    
    try {
      const passphrase = getAdminPassphrase();
      const resp = await fetch(`${API_BASE_URL}/api/admin/subjects`, {
        headers: {
          'X-Admin-Passphrase': passphrase
        },
        credentials: 'include'
      });
      
      if (!resp.ok) {
        throw new Error('Failed to load subjects configuration');
      }
      
      const data = await resp.json();
      
      if (Object.keys(data).length === 0) {
        loadingEl.style.display = 'none';
        emptyEl.style.display = 'block';
        return;
      }
      
      renderSubjectsConfig(data);
      loadingEl.style.display = 'none';
      contentEl.style.display = 'block';
    } catch (e) {
      console.error('Failed to load subjects config', e);
      loadingEl.style.display = 'none';
      messageEl.innerHTML = `<p style="color: #dc2626;">Failed to load: ${e.message}</p>`;
    }
  }

  function renderSubjectsConfig(data) {
    const listEl = document.getElementById('subjects-list');
    let html = '';
    
    for (const [courseId, semesters] of Object.entries(data).sort()) {
      html += `<div style="margin-bottom: 2rem; border: 1px solid var(--admin-border); border-radius: 8px; overflow: hidden;">`;
      html += `<div style="background: var(--admin-bg-secondary); padding: 1rem; border-bottom: 1px solid var(--admin-border);">`;
      html += `<h3 style="margin: 0;">${courseId}</h3>`;
      html += `</div>`;
      
      for (const [semester, subjects] of Object.entries(semesters).sort()) {
        html += `<div style="padding: 1rem; border-bottom: 1px solid var(--admin-border);">`;
        html += `<h4 style="margin: 0 0 0.75rem 0;">${semester}</h4>`;
        html += `<table style="width: 100%; font-size: 0.9rem;">`;
        html += `<thead>`;
        html += `<tr style="background: rgba(0,0,0,0.05);">`;
        html += `<th style="text-align: left; padding: 0.5rem;">Code</th>`;
        html += `<th style="text-align: left; padding: 0.5rem;">Name</th>`;
        html += `<th style="text-align: left; padding: 0.5rem;">Order</th>`;
        html += `<th style="text-align: center; padding: 0.5rem;">Actions</th>`;
        html += `</tr>`;
        html += `</thead>`;
        html += `<tbody>`;
        
        for (const subject of subjects) {
          html += `<tr style="border-top: 1px solid var(--admin-border);">`;
          html += `<td style="padding: 0.5rem;">${subject.v}</td>`;
          html += `<td style="padding: 0.5rem;">${subject.t}</td>`;
          html += `<td style="padding: 0.5rem;">${subject.display_order ?? 0}</td>`;
          html += `<td style="padding: 0.5rem; text-align: center;">`;
          html += `<button class="admin-btn-action admin-btn-action-edit" style="margin-right: 0.25rem;" onclick="editSubjectConfig('${subject.id}', '${courseId}', '${semester}', '${subject.v}', '${subject.t}', ${subject.display_order ?? 0})">Edit</button>`;
          html += `<button class="admin-btn-action admin-btn-action-delete" onclick="deleteSubjectConfig('${subject.v}', '${courseId}', '${semester}')">Delete</button>`;
          html += `</td>`;
          html += `</tr>`;
        }
        
        html += `</tbody>`;
        html += `</table>`;
        html += `</div>`;
      }
      
      html += `</div>`;
    }
    
    document.getElementById('subjects-list').innerHTML = html;
  }

  async function addSubject(e) {
    e.preventDefault();
    
    const courseId = document.getElementById('subject-course').value.trim();
    const semester = document.getElementById('subject-semester').value.trim();
    const subjectCode = document.getElementById('subject-code').value.trim();
    const subjectName = document.getElementById('subject-name').value.trim();
    const displayOrder = parseInt(document.getElementById('subject-order').value) || 0;
    
    if (!courseId || !semester || !subjectCode || !subjectName) {
      showMessage('All fields are required', 'error');
      return;
    }
    
    const messageEl = document.getElementById('subjects-message');
    const submitBtn = document.querySelector('#add-subject-form button[type="submit"]');
    if (submitBtn) submitBtn.disabled = true;
    messageEl.innerHTML = '<p style="color: var(--admin-text-secondary);">Adding subject...</p>';
    
    try {
      const passphrase = getAdminPassphrase();
      const resp = await fetch(`${API_BASE_URL}/api/admin/subjects`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-Admin-Passphrase': passphrase
        },
        credentials: 'include',
        body: JSON.stringify({
          course_id: courseId,
          semester: semester,
          subject_code: subjectCode,
          subject_name: subjectName,
          display_order: displayOrder
        })
      });
      
      if (!resp.ok) {
        const error = await resp.json();
        throw new Error(error.error || 'Failed to add subject');
      }
      
      messageEl.innerHTML = '<p style="color: #059669;">✓ Subject added successfully!</p>';
      document.getElementById('add-subject-form').reset();
      
      setTimeout(() => {
        loadSubjectsConfig();
      }, 1000);
    } catch (e) {
      console.error('Failed to add subject', e);
      messageEl.innerHTML = `<p style="color: #dc2626;">Failed: ${e.message}</p>`;
    } finally {
      if (submitBtn) submitBtn.disabled = false;
    }
  }

  async function editSubjectConfig(id, course, semester, code, name, order = 0) {
    const passphrase = getAdminPassphrase();
    const messageEl = document.getElementById('subjects-message');

    const newCode = prompt('Subject code', code);
    if (newCode === null) return;
    const newName = prompt('Subject name', name);
    if (newName === null) return;
    const orderInput = prompt('Display order (number)', String(order ?? 0));
    if (orderInput === null) return;
    const newOrder = parseInt(orderInput, 10);

    if (!newCode.trim() || !newName.trim() || Number.isNaN(newOrder)) {
      showMessage('Invalid input for subject update', 'error');
      return;
    }

    messageEl.innerHTML = '<p style="color: var(--admin-text-secondary);">Updating subject...</p>';

    try {
      const resp = await fetch(`${API_BASE_URL}/api/admin/subjects/${id}`, {
        method: 'PATCH',
        headers: {
          'Content-Type': 'application/json',
          'X-Admin-Passphrase': passphrase
        },
        credentials: 'include',
        body: JSON.stringify({
          subject_code: newCode.trim(),
          subject_name: newName.trim(),
          display_order: newOrder
        })
      });

      if (!resp.ok) {
        const error = await resp.json().catch(() => ({}));
        throw new Error(error.error || 'Failed to update subject');
      }

      messageEl.innerHTML = '<p style="color: #059669;">✓ Subject updated!</p>';
      await loadSubjectsConfig();
    } catch (err) {
      console.error('Failed to update subject', err);
      messageEl.innerHTML = `<p style="color: #dc2626;">Failed to update: ${err.message}</p>`;
    }
  }

  window.editSubjectConfig = editSubjectConfig;

  async function deleteSubjectConfig(code, course, semester) {
    if (!confirm(`Delete ${code} from ${course}/${semester}?`)) {
      return;
    }
    
    try {
      const passphrase = getAdminPassphrase();
      
      // Get the subject ID first
      const getResp = await fetch(`${API_BASE_URL}/api/admin/subjects`, {
        headers: {
          'X-Admin-Passphrase': passphrase
        },
        credentials: 'include'
      });
      
      if (!getResp.ok) throw new Error('Failed to fetch subjects');
      
      const allSubjects = await getResp.json();
      const subjects = allSubjects[course]?.[semester] || [];
      const subject = subjects.find(s => s.v === code);
      
      if (!subject || !subject.id) {
        // If no ID in the response, we need to implement a way to get it
        showMessage('Subject not found or cannot be deleted', 'error');
        return;
      }
      
      const delResp = await fetch(`${API_BASE_URL}/api/admin/subjects/${subject.id}`, {
        method: 'DELETE',
        headers: {
          'X-Admin-Passphrase': passphrase
        },
        credentials: 'include'
      });
      
      if (!delResp.ok) {
        const error = await delResp.json();
        throw new Error(error.error || 'Failed to delete subject');
      }
      
      showMessage('Subject deleted successfully!');
      await loadSubjectsConfig();
    } catch (e) {
      console.error('Failed to delete subject', e);
      showMessage('Failed to delete: ' + e.message, 'error');
    }
  }

  window.deleteSubjectConfig = deleteSubjectConfig;

  // Load subjects when tab is clicked
  document.querySelector('[data-tab="subjects"]').addEventListener('click', () => {
    loadSubjectsConfig();
  });

  // Add subject form listener
  document.getElementById('add-subject-form').addEventListener('submit', addSubject);
});
</script>
{% endblock main_content %}