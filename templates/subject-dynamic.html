{% extends "base.html" %}

{% block main_content %}
<link rel="stylesheet" href="/css/index.css">
<link defer rel="stylesheet" href="/css/alerts.css">
<script defer src="/js/openLinkHandler.js"></script>
<style>
    .search-filters {
        background: rgba(31, 41, 55, 0.95);
        backdrop-filter: blur(10px);
        border: 1px solid #374151;
        border-radius: 8px;
        padding: 1.5rem;
        margin: 1.5rem 0;
    }
    
    .filter-row {
        display: flex;
        gap: 1.5rem;
        align-items: end;
    }
    
    .filter-field {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }
    
    .filter-field label {
        color: #9ca3af;
        font-size: 0.875rem;
        font-weight: 500;
    }
    
    .filter-field input {
        background: rgba(17, 24, 39, 0.9);
        border: 1px solid #374151;
        border-radius: 6px;
        padding: 0.625rem 0.875rem;
        color: #f3f4f6;
        font-size: 0.95rem;
        transition: all 0.2s;
    }
    
    .filter-field input:focus {
        outline: none;
        border-color: #10b981;
        box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
    }
    
    .filter-field input::placeholder {
        color: #6b7280;
    }
    
    .filter-btn, .clear-btn {
        padding: 0.625rem 1.25rem;
        border-radius: 6px;
        border: none;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 0.95rem;
    }
    
    .filter-btn {
        background: #10b981;
        color: white;
    }
    
    .filter-btn:hover {
        background: #059669;
    }
    
    .clear-btn {
        background: #374151;
        color: #f3f4f6;
    }
    
    .clear-btn:hover {
        background: #4b5563;
    }
    
    .no-results {
        display: none;
        text-align: center;
        padding: 3rem;
        color: #9ca3af;
        font-size: 1.1rem;
    }
    
    .loading {
        text-align: center;
        padding: 3rem;
        color: #9ca3af;
        font-size: 1.1rem;
    }
    
    .error {
        text-align: center;
        padding: 3rem;
        color: #ef4444;
        font-size: 1.1rem;
    }
</style>
<main>
    {% include 'components/login.html' %}
    <article>
        <section class="body" style="display: none;">
            <br>
            <div class="alerts">
                <div class="alert alert-info">
                    <div class="alert-type">
                        <strong>Disclaimer</strong>
                    </div>
                    <div class="alert-content">
                        This site is in no way affiliated to PESU Academy or pes.edu.
                        All content is borrowed from PESU Academy unless explicitly stated.
                    </div>
                </div>
            </div><br>
            {{ post_macros::page_header(title=page.title) }}
            {{ page.content | safe }}
            
            <!-- Search and Filter Section -->
            <div class="search-filters">
                <div class="filter-row">
                    <div class="filter-field">
                        <label for="search-input">Search Resources</label>
                        <input 
                            type="text" 
                            id="search-input" 
                            placeholder="Search by title, link, or file name..."
                        >
                    </div>
                    <button class="filter-btn" onclick="applyFilters()">Search</button>
                    <button class="clear-btn" onclick="clearFilters()">Clear</button>
                </div>
            </div>
            
            <div id="loading" class="loading">
                Loading resources...
            </div>
            
            <div id="error" class="error" style="display: none;">
                Failed to load resources. Please try again later.
            </div>
            
            <div id="no-results" class="no-results">
                No resources found matching your search.
            </div>
            
            <div class="parent-parent" id="content-area" style="display: none;">
                <ul class="parent" style="list-style-type: none;">
                    <li id="subject-content">
                        <!-- Content will be dynamically loaded here -->
                    </li>
                </ul>
            </div>
        </section>
    </article>
</main>
<script>
    // Get subject code from page extra or URL
    const subjectCode = '{{ page.extra.subject_code }}';
    const WORKER_URL = (location.hostname === 'pes-bca.pages.dev') ? 'https://cors-proxy.devpages.workers.dev' : 'http://localhost:8787';
    
    // Subject code to full name mapping (from uploadFiles.html)
    const subjectNames = {
        'cfp': 'Computing Fundamentals with Python',
        'wd': 'Web Design',
        'mfca': 'Mathematical Foundation for Computer Applications',
        'mp': 'Macro Programming',
        'pce': 'Professional Communication and Ethics',
        'indc': 'Indian Constitution',
        'cprog': 'Programming with C',
        'db': 'Database Systems',
        'pos': 'Platforms and Operating Systems',
        'coa': 'Computer Organization and Architecture',
        'pd': 'Personality Development',
        'evs': 'Environmental Studies',
        'ds': 'Data Structures',
        'oop': 'Object Oriented Programming',
        'dc': 'Data Communication',
        'elec1': 'Elective I',
        'dm': 'Digital Marketing',
        'da': 'Design of Algorithms',
        'wad': 'Web Application Design',
        'se': 'Software Engineering',
        'elec2': 'Elective II',
        'cyberlaw': 'Cyber Law',
        'waf': 'Web Application Framework',
        'stats': 'Statistics and R Programming',
        'elec3': 'Elective III',
        'elec4': 'Elective IV',
        'entre': 'Entrepreneurship',
        'cloud': 'Cloud Technologies',
        'intern': 'Internship/Swayam/MOOC',
        'dsa': 'Data Structures and Algorithms'
    };
    
    // Shared utility: Get nesting level of a details element
    function getDetailsLevel(element) {
        let level = 0;
        let parent = element.parentElement;
        while (parent) {
            if (parent.tagName === 'DETAILS') {
                level++;
            }
            parent = parent.parentElement;
        }
        return level;
    }
    
    // Fetch and render subject resources
    async function loadSubjectResources() {
        try {
            const response = await fetch(`${WORKER_URL}/api/subject/resources?subject=${encodeURIComponent(subjectCode)}`);
            
            if (!response.ok) {
                throw new Error('Failed to fetch resources');
            }
            
            const data = await response.json();
            renderSubjectContent(data);
            
            document.getElementById('loading').style.display = 'none';
            document.getElementById('content-area').style.display = 'block';
            
            // Initialize details toggle behavior
            initializeDetailsToggle();
            
        } catch (error) {
            console.error('Error loading subject resources:', error);
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error').style.display = 'block';
        }
    }
    
    // Render the hierarchical structure
    function renderSubjectContent(data) {
        const container = document.getElementById('subject-content');
        // Priority: API subjectName > client-side mapping > subject code
        const subjectName = data.subjectName || subjectNames[subjectCode] || data.subject || subjectCode;
        
        let html = `
            <details>
                <summary>
                    ${subjectName}
                    <sup><a href="/sem-1/${subjectCode.toLowerCase()}/" style="border-bottom: none;">
                        <svg width="1em" height="1em" viewBox="0 0 24 30" fill="currentColor" style="vertical-align:middle; margin-left: -0.25em">
                            <path class="cls-1" d="m21,12v6c0,1.6543-1.3457,3-3,3H6c-1.6543,0-3-1.3457-3-3V6c0-1.6543,1.3457-3,3-3h6c.55273,0,1,.44775,1,1s-.44727,1-1,1h-6c-.55176,0-1,.44873-1,1v12c0,.55127.44824,1,1,1h12c.55176,0,1-.44873,1-1v-6c0-.55225.44727-1,1-1s1,.44775,1,1Zm-1-9h-4c-.55273,0-1,.44775-1,1s.44727,1,1,1h1.58594l-9.29297,9.29297c-.39062.39062-.39062,1.02344,0,1.41406.19531.19531.45117.29297.70703.29297s.51172-.09766.70703-.29297l9.29297-9.29297v1.58594c0,.55225.44727,1,1,1s1-.44775,1-1v-4c0-.55225-.44727-1-1-1Z"/>
                        </svg>
                    </a></sup>
                </summary>
                <ul>
        `;
        
        // Iterate through units
        for (const [unit, types] of Object.entries(data.resources)) {
            html += `
                <li>
                    <details>
                        <summary>Unit-${unit}</summary>
                        <ul>
                            <li>
            `;
            
            // Iterate through resource types within each unit
            for (const [type, resources] of Object.entries(types)) {
                html += `
                    <details>
                        <summary>${type}</summary>
                        <ul>
                `;
                
                // Add individual resources
                for (const resource of resources) {
                    html += `<li><a href="${resource.url}">${resource.title}</a></li>\n`;
                }
                
                html += `
                        </ul>
                    </details>
                `;
            }
            
            html += `
                            </li>
                        </ul>
                    </details>
                </li>
            `;
        }
        
        html += `
                </ul>
            </details>
        `;
        
        container.innerHTML = html;
    }
    
    // Initialize details toggle behavior
    function initializeDetailsToggle() {
        // Open first 2 levels
        document.querySelectorAll('details').forEach(function (details) {
            const level = getDetailsLevel(details);
            if (level < 2) {
                details.open = true;
            }
        });

        // Close all child <details> when a parent <details> is closed
        document.querySelectorAll('details').forEach(function (details) {
            details.addEventListener('toggle', function () {
                if (!details.open) {
                    details.querySelectorAll('details').forEach(function (child) {
                        child.open = false;
                    });
                }
            });
        });
    }
    
    // Search and filter functionality
    function applyFilters() {
        const searchTerm = document.getElementById('search-input').value.toLowerCase().trim();
        const contentArea = document.getElementById('content-area');
        const noResults = document.getElementById('no-results');
        
        if (!searchTerm) {
            clearFilters();
            return;
        }
        
        let foundAny = false;
        
        // Search through all links
        const allLinks = contentArea.querySelectorAll('a');
        allLinks.forEach(link => {
            const text = link.textContent.toLowerCase();
            const href = link.getAttribute('href') ? link.getAttribute('href').toLowerCase() : '';
            const matches = text.includes(searchTerm) || href.includes(searchTerm);
            
            // Find the closest parent li
            let listItem = link.closest('li');
            if (listItem) {
                if (matches) {
                    listItem.style.display = '';
                    foundAny = true;
                    
                    // Show all parent details elements
                    let parent = listItem.parentElement;
                    while (parent) {
                        if (parent.tagName === 'DETAILS') {
                            parent.open = true;
                            parent.style.display = '';
                        }
                        if (parent.tagName === 'LI') {
                            parent.style.display = '';
                        }
                        parent = parent.parentElement;
                    }
                } else {
                    // Only hide leaf items (items without nested details)
                    const hasNestedDetails = listItem.querySelector('details');
                    if (!hasNestedDetails) {
                        listItem.style.display = 'none';
                    }
                }
            }
        });
        
        // Hide empty details sections
        contentArea.querySelectorAll('details').forEach(details => {
            const visibleItems = Array.from(details.querySelectorAll(':scope > ul > li')).filter(li => {
                return li.style.display !== 'none';
            });
            
            if (visibleItems.length === 0) {
                details.style.display = 'none';
            } else {
                details.style.display = '';
            }
        });
        
        noResults.style.display = foundAny ? 'none' : 'block';
        contentArea.style.display = foundAny ? 'block' : 'none';
    }
    
    function clearFilters() {
        document.getElementById('search-input').value = '';
        const contentArea = document.getElementById('content-area');
        const noResults = document.getElementById('no-results');
        
        // Show all items
        contentArea.querySelectorAll('li, details').forEach(el => {
            el.style.display = '';
        });
        
        // Reset details to initial state (first 2 levels open)
        contentArea.querySelectorAll('details').forEach(details => {
            const level = getDetailsLevel(details);
            details.open = level < 2;
        });
        
        noResults.style.display = 'none';
        contentArea.style.display = 'block';
    }
    
    // Search on Enter key
    document.addEventListener('DOMContentLoaded', function() {
        if (!sessionStorage.getItem('user_session')) { 
            localStorage.setItem('postLoginRedirect', window.location.href); 
        }
        
        const searchInput = document.getElementById('search-input');
        if (searchInput) {
            searchInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    applyFilters();
                }
            });
        }
        
        // Load subject resources on page load
        loadSubjectResources();
    });
</script>
{% endblock main_content %}
