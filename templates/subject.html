{% extends "base.html" %}

{% block main_content %}
<link rel="stylesheet" href="/css/index.css?v={{ config.extra.sw_version }}">
<link defer rel="stylesheet" href="/css/alerts.css?v={{ config.extra.sw_version }}">
<script defer src="/js/openLinkHandler.js?v={{ config.extra.sw_version }}"></script>
<style>
    .search-filters {
        background: rgba(31, 41, 55, 0.95);
        backdrop-filter: blur(10px);
        border: 1px solid #374151;
        border-radius: 8px;
        padding: 1rem;
        margin: 1.5rem 0;
    }
    
    .filter-row {
        display: flex;
        gap: 1.5rem;
        align-items: end;
    }
    
    .filter-field {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }
    
    .filter-field label {
        color: #9ca3af;
        font-size: 0.875rem;
        font-weight: 500;
    }
    
    .filter-field input {
        background: rgba(17, 24, 39, 0.9);
        border: 1px solid #374151;
        border-radius: 6px;
        padding: 0.625rem 0.875rem;
        color: #f3f4f6;
        font-size: 0.95rem;
        transition: border-color 0.3s ease, box-shadow 0.2s ease, background 0.2s ease;
    }

    .filter-field input:focus {
        outline: none;
        /* Animate the entire border to the accent color */
        border-color: #10b981;
        box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
    }
    
    .filter-field input::placeholder {
        color: #6b7280;
    }
    
    .filter-btn, .clear-btn {
        padding: 0.625rem 1.25rem;
        border-radius: 6px;
        border: none;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 0.95rem;
    }
    
    .filter-btn {
        background: #10b981;
        color: white;
    }
    
    .filter-btn:hover {
        background: #059669;
    }
    
    .clear-btn {
        background: #374151;
        color: #f3f4f6;
    }
    
    .clear-btn:hover {
        background: #4b5563;
    }
    
    .no-results {
        display: none;
        text-align: center;
        padding: 3rem;
        color: #9ca3af;
        font-size: 1.1rem;
    }
    
    .loading {
        text-align: center;
        padding: 3rem;
        color: #9ca3af;
        font-size: 1.1rem;
    }
    
    .error {
        text-align: center;
        padding: 3rem;
        color: #ef4444;
        font-size: 1.1rem;
    }
</style>
<main>
    {% include 'components/login.html' %}
    <article>
        <section class="body" style="display: none;">
            <br>
            <div class="alerts">
                <div class="alert alert-info">
                    <div class="alert-type">
                        <strong>Disclaimer</strong>
                    </div>
                    <div class="alert-content">
                        This site is in no way affiliated to PESU Academy or pes.edu.
                        All content is borrowed from PESU Academy unless explicitly stated.
                    </div>
                </div>
            </div><br>
            {{ page.content | safe }}
            
            <!-- Search and Filter Section -->
            <div class="search-filters">
                <div class="filter-row">
                    <div class="filter-field">
                        <input 
                            type="text" 
                            id="search-input" 
                            placeholder="Search by title, link, or file name..."
                        >
                    </div>
                    <button class="clear-btn" onclick="clearFilters()">Clear</button>
                </div>
            </div>
            
            <div id="loading" class="loading">
                Loading resources...
            </div>
            
            <div id="error" class="error" style="display: none;">
                Failed to load resources. Please try again later.
            </div>
            
            <div id="no-results" class="no-results">
                No resources found matching your search.
            </div>
            <div class="parent-parent" id="content-area" style="display: none;">
                <ul class="parent" style="list-style-type: none;">
                    <li id="subject-content">
                        <!-- Content will be dynamically loaded here -->
                    </li>
                </ul>
            </div>
        </section>
    </article>
</main>
<script type="module">
    // Get subject code and semester from page extra 
    const subjectCode = '{{ page.extra.subject_code }}';
    const semester = '{{ page.extra.semester | default(value="1") }}';
    // Use the same-origin API base when available so requests go through Pages Functions.
    // During local development, window.API_BASE_URL is set to 'http://localhost:8787'.
    import { API_BASE_URL } from '/js/utils.js?v={{ config.extra.sw_version }}';
    const WORKER_URL = API_BASE_URL;
    
    // Import shared search/filter utilities
    import { 
        applyFilters, 
        clearFilters, 
        initializeSearchOnEnter, 
        initializeDetailsToggle 
    } from '/js/resource-search.js?v={{ config.extra.sw_version }}';
    
    // Use shared resource cache instead of per-subject cache
    const SHARED_CACHE_KEY = 'all_resources_snapshot_v2';
    const SUBJECT_CACHE_HASH_KEY = `subject_etag_v2_${subjectCode}`;
    
    let cachedData = null;

    function loadCachedSubject() {
        try {
            // Load from shared cache and filter for this subject
            const raw = localStorage.getItem(SHARED_CACHE_KEY);
            if (!raw) return false;
            const allResources = JSON.parse(raw);
            if (!Array.isArray(allResources)) return false;
            
            // Filter resources for this subject
            const subjectResources = allResources.filter(r => r.subject === subjectCode);
            if (subjectResources.length === 0) return false;
            
            // Organize into hierarchical structure
            const organized = organizeResourcesClientSide(subjectResources);
            cachedData = { subject: subjectCode, resources: organized };
            
            renderSubjectContent(cachedData);
            document.getElementById('loading').style.display = 'none';
            document.getElementById('content-area').style.display = 'block';
            initializeDetailsToggle();
            try { initSubjectSuggest(); } catch (e) {}
            return true;
        } catch (e) { 
            console.warn('Failed to load cached subject:', e);
            return false; 
        }
    }
    
    // Build PDF viewer URL from resource metadata
    function buildResourceUrl(resource, unit) {
        const semNum = resource.semester?.match(/\d+/)?.[0] || '1';
        const actualUnit = unit || resource.unit || 'General';
        const type = resource.resource_type || 'Other';
        const filename = (resource.filename);
        // Prefer explicit title property (added during organization), then link_title, then filename
        const rawTitle = resource.title || resource.link_title || resource.filename;
        const title = (rawTitle);

        // Use subjectCode from page context (resources from API don't have subject field)
        let filePath;
        if (actualUnit === 'all') {
            // For unit-all resources, include the resource_type in the path
            filePath = `sem-${semNum}/${subjectCode}/${type}/unit-all/${filename}`;
        } else {
            filePath = `sem-${semNum}/${subjectCode}/unit-${actualUnit}/${filename}`;
        }

        return `/pdf-viewer?file=${(filePath)}&title=${title}`;
    }
    
    // Client-side organization function (mirrors server logic)
    function organizeResourcesClientSide(resources) {
        const organized = {};
        
        for (const resource of resources) {
            const unit = resource.unit || 'General';
            const type = resource.resource_type || 'Other';
            
            if (!organized[unit]) organized[unit] = {};
            if (!organized[unit][type]) organized[unit][type] = [];
            
            // Keep unit and resource_type for buildNav sorting and URL building
            organized[unit][type].push({
                id: resource.id,
                title: resource.link_title, // canonical display title
                link_title: resource.link_title, // keep original field name for consumers expecting it
                filename: resource.filename,
                semester: resource.semester, // preserve semester for URL building
                unit: unit,
                resource_type: type
            });
        }
        
        // Sort units (1, 2, 3, 4, then "all", then General)
        const sortedUnits = {};
        const unitKeys = Object.keys(organized).sort((a, b) => {
            const numA = parseInt(a);
            const numB = parseInt(b);
            if (!isNaN(numA) && !isNaN(numB)) return numA - numB;
            if (a === 'all') return isNaN(numB) && b !== 'General' ? 1 : -1;
            if (b === 'all') return isNaN(numA) && a !== 'General' ? -1 : 1;
            if (a === 'General') return 1;
            if (b === 'General') return -1;
            return a.localeCompare(b);
        });
        
        for (const key of unitKeys) {
            sortedUnits[key] = organized[key];
        }
        
        return sortedUnits;
    }

    // Fetch and render subject resources with ETag conditional request
    async function loadSubjectResources() {
        try {
            const etag = localStorage.getItem(SUBJECT_CACHE_HASH_KEY);
            // Add timestamp to bypass Chrome's aggressive caching (removed after ETag is established)
            const url = `${WORKER_URL}/api/subject/resources?subject=${(subjectCode)}&_t=${Date.now()}`;
            const response = await fetch(url, { headers: etag ? { 'If-None-Match': etag } : {} });
                        
            if (response.status === 304) {
                // No change - ensure UI is visible
                document.getElementById('loading').style.display = 'none';
                document.getElementById('content-area').style.display = 'block';
                return;
            }
            
            if (!response.ok) {
                const errorText = await response.text();
                console.error('Response error:', response.status, errorText);
                throw new Error(`Failed to fetch resources: ${response.status} ${errorText.slice(0, 100)}`);
            }
            
            const data = await response.json();
            
            // Handle delta updates
            if (data.delta && cachedData) {
                console.log(`Delta update for subject ${subjectCode}`);
                // Merge delta with cached organized structure
                const merged = JSON.parse(JSON.stringify(cachedData.resources || {}));
                
                // Apply updates from delta
                if (data.resources) {
                    for (const [unit, types] of Object.entries(data.resources)) {
                        if (!merged[unit]) merged[unit] = {};
                        for (const [type, resources] of Object.entries(types)) {
                            if (!merged[unit][type]) {
                                merged[unit][type] = resources;
                            } else {
                                // Merge resources by ID
                                const resourceMap = new Map(merged[unit][type].map(r => [r.id, r]));
                                resources.forEach(r => resourceMap.set(r.id, r));
                                merged[unit][type] = Array.from(resourceMap.values());
                            }
                        }
                    }
                }
                
                // Remove deleted resources
                if (data.deleted && data.deleted.length > 0) {
                    for (const [unit, types] of Object.entries(merged)) {
                        for (const [type, resources] of Object.entries(types)) {
                            merged[unit][type] = resources.filter(r => !data.deleted.includes(r.id));
                        }
                    }
                }
                
                cachedData = { ...data, resources: merged };
            } else {
                // Full update
                cachedData = data;
            }
            
            renderSubjectContent(cachedData);
            try {
                // Update ETag for this subject
                if (cachedData.hash) localStorage.setItem(SUBJECT_CACHE_HASH_KEY, cachedData.hash);
                
                // Note: Do NOT update shared cache here - organized structure lacks context fields
                // The shared cache is only updated by the homepage resources API which has full metadata
            } catch (e) {}
            
            document.getElementById('loading').style.display = 'none';
            document.getElementById('content-area').style.display = 'block';
            
            // Initialize details toggle behavior
            initializeDetailsToggle();

            // Initialize search suggestion for subject page
            try {
                initSubjectSuggest();
            } catch (err) {
                console.warn('Subject search suggest init failed', err);
            }
            
        } catch (error) {
            console.error('Error loading subject resources:', error);
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error').style.display = 'block';
        }
    }

    // Initialize search suggestions for subject page using rendered links
    async function initSubjectSuggest() {
        try {
            const mod = await import('/js/init-search-suggest.js?v={{ config.extra.sw_version }}');
            const initSubjectSearchSuggest = mod.initSubjectSearchSuggest;
            const inputEl = document.getElementById('search-input');
            initSubjectSearchSuggest(inputEl, applyFilters);
        } catch (err) {
            console.warn('Failed to init subject search suggest', err);
        }
    }
    
    // Render the hierarchical structure
    function renderSubjectContent(data) {
        const container = document.getElementById('subject-content');
        // Priority: API subjectName > subject code uppercase
        const subjectName = data.subjectName || (data.subject && data.subject.toUpperCase()) || subjectCode.toUpperCase();
        
        let html = `
            <details>
                <summary>
                    ${subjectName}
                    <sup><a href="/sem-1/${subjectCode.toLowerCase()}/" style="border-bottom: none;">
                        <svg width="1em" height="1em" viewBox="0 0 24 30" fill="currentColor" style="vertical-align:middle; margin-left: -0.25em">
                            <path class="cls-1" d="m21,12v6c0,1.6543-1.3457,3-3,3H6c-1.6543,0-3-1.3457-3-3V6c0-1.6543,1.3457-3,3-3h6c.55273,0,1,.44775,1,1s-.44727,1-1,1h-6c-.55176,0-1,.44873-1,1v12c0,.55127.44824,1,1,1h12c.55176,0,1-.44873,1-1v-6c0-.55225.44727-1,1-1s1,.44775,1,1Zm-1-9h-4c-.55273,0-1,.44775-1,1s.44727,1,1,1h1.58594l-9.29297,9.29297c-.39062.39062-.39062,1.02344,0,1.41406.19531.19531.45117.29297.70703.29297s.51172-.09766.70703-.29297l9.29297-9.29297v1.58594c0,.55225.44727,1,1,1s1-.44775,1-1v-4c0-.55225-.44727-1-1-1Z"/>
                        </svg>
                    </a></sup>
                </summary>
                <ul>
        `;
        
        // Iterate through units
        for (const [unit, types] of Object.entries(data.resources)) {
            const unitLabel = (unit === 'all') ? 'Applicable to all Units' : `Unit-${unit}`;
            html += `
                <li>
                    <details>
                        <summary>${unitLabel}</summary>
                        <ul>
                            <li>
            `;
            
            // Iterate through resource types within each unit
            for (const [type, resources] of Object.entries(types)) {
                html += `
                    <details>
                        <summary>${type}</summary>
                        <ul>
                `;
                
                // Sort resources by leading number in filename
                const sortedResources = resources.sort((a, b) => {
                    const aFilename = a.filename || '';
                    const bFilename = b.filename || '';
                    
                    // Extract leading number from filename (handles 1, 01, 001, etc.)
                    const aMatch = aFilename.match(/^(\d+)/);
                    const bMatch = bFilename.match(/^(\d+)/);
                    
                    const aNum = aMatch ? parseInt(aMatch[1]) : 999999;
                    const bNum = bMatch ? parseInt(bMatch[1]) : 999999;
                    
                    return aNum - bNum;
                });
                
                // Add individual resources (build URL on demand)
                for (const resource of sortedResources) {
                    // Ensure resource_type is set (it should be from the organization, but explicitly set it here)
                    const resourceWithType = { ...resource, resource_type: resource.resource_type || type };
                    const url = buildResourceUrl(resourceWithType, unit);
                    const title = resource.title || resource.filename;
                    const filename = resource.filename || '';
                    html += `<li><a href="${url}" data-filename="${filename}" data-title="${resource.title || ''}">${title}</a></li>\n`;
                }
                
                html += `
                        </ul>
                    </details>
                `;
            }
            
            html += `
                            </li>
                        </ul>
                    </details>
                </li>
            `;
        }
        
        html += `
                </ul>
            </details>
        `;
        
        container.innerHTML = html;
    }
    
    // Expose functions to window scope for onclick handlers
    window.applyFilters = () => applyFilters('search-input', 'content-area', 'no-results');
    window.clearFilters = () => clearFilters('search-input', 'content-area', 'no-results');
    
    // Initialize search functionality on DOM ready
    document.addEventListener('DOMContentLoaded', function() {
        initializeSearchOnEnter('search-input');
        initializeDetailsToggle('content-area', 2);
        
        // Attempt cached render first then conditional refresh
        loadCachedSubject();
        loadSubjectResources();
        
        // Refresh when tab regains focus
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden) {
                loadSubjectResources();
            }
        });
    });
</script>
{% endblock main_content %}
